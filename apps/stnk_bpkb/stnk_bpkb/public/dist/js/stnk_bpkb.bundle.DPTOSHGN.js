(()=>{frappe.provide("stnk_bpkb.selling");stnk_bpkb.sales_common={setup_selling_controller:function(f){stnk_bpkb.selling.SellingController=class extends f{setup(){super.setup(),this.frm._item_table=in_list(["FPK","SPK"],this.frm.doctype)?null:"items",this.frm._custom_field=in_list(["FPK","SPK"],this.frm.doctype)?"":"custom_",this.frm._discount_field=in_list(["FPK","SPK"],this.frm.doctype)?"item_discount_amount":"discount_amount",in_list(["FPK","SPK"],this.frm.doctype)?frappe.ui.form.on(this.frm.doctype,"rate",function(t){var r=frappe.meta.has_field(t.doc.doctype,"margin_type");if(frappe.model.round_floats_in(t.doc,["rate","price_list_rate"]),t.doc.price_list_rate){var _=t.doc.rate-(t.doc[`${t._custom_field}stnk_rate`]+t.doc[`${t._custom_field}bpkb_rate`]+t.doc[`${t._custom_field}bbn_rate`]);_>t.doc.price_list_rate&&r?(t.doc.discount_percentage=0,t.doc.item_discount_amount=0,t.doc.margin_type="Amount",t.doc.margin_rate_or_amount=flt(_-t.doc.price_list_rate,precision("margin_rate_or_amount",t.doc)),t.doc.rate_with_margin=_):(t.doc.discount_percentage=flt((1-_/t.doc.price_list_rate)*100,precision("discount_percentage",t.doc)),t.doc.item_discount_amount=flt(t.doc.price_list_rate)-flt(_),t.doc.margin_type="",t.doc.margin_rate_or_amount=0,t.doc.rate_with_margin=0)}else t.doc.discount_percentage=0,t.doc.margin_type="",t.doc.margin_rate_or_amount=0,t.doc.rate_with_margin=0;t.doc.base_rate_with_margin=t.doc.rate_with_margin*flt(t.doc.conversion_rate),cur_frm.cscript.calculate_taxes_and_totals()}):(frappe.ui.form.off(this.frm.doctype+" Item","rate"),frappe.ui.form.on(this.frm.doctype+" Item","rate",function(t,r,_){var e=frappe.get_doc(r,_),o=frappe.meta.has_field(r,"margin_type");if(frappe.model.round_floats_in(e,["rate","price_list_rate"]),e.price_list_rate&&!e.blanket_order_rate){var a=e.rate-(e[`${t._custom_field}stnk_rate`]+e[`${t._custom_field}bpkb_rate`]+e[`${t._custom_field}bbn_rate`]);a>e.price_list_rate&&o?(e.discount_percentage=0,e.discount_amount=0,e.margin_type="Amount",e.margin_rate_or_amount=flt(a-e.price_list_rate,precision("margin_rate_or_amount",e)),e.rate_with_margin=a):(e.discount_percentage=flt((1-a/e.price_list_rate)*100,precision("discount_percentage",e)),e.discount_amount=flt(e.price_list_rate)-flt(a),e.margin_type="",e.margin_rate_or_amount=0,e.rate_with_margin=0)}else e.discount_percentage=0,e.margin_type="",e.margin_rate_or_amount=0,e.rate_with_margin=0;e.base_rate_with_margin=e.rate_with_margin*flt(t.doc.conversion_rate),cur_frm.cscript.set_gross_profit(e),cur_frm.cscript.calculate_taxes_and_totals(),cur_frm.cscript.calculate_stock_uom_rate(t,r,_)}))}transaction_date(){super.transaction_date(),this.reaply_pricing_rule()}off_the_road_pricing(){this.reaply_pricing_rule()}custom_off_the_road_pricing(t,r,_){this.item_code(t,r,_),this.reaply_pricing_rule()}territory(){this.reaply_pricing_rule()}custom_territory_pemilik(){this.reaply_pricing_rule()}territory_area(){this.reaply_pricing_rule()}custom_territory(t,r,_){this.item_code(t,r,_),this.reaply_pricing_rule()}custom_territory_area(t,r,_){this.item_code(t,r,_),this.reaply_pricing_rule()}reaply_pricing_rule(){var t=this,r=in_list(["FPK","SPK"],this.frm.doctype)?[this.frm.doc]:this.frm.doc.items;$.each(r||[],function(_,e){(e.item_code||e.product)&&t.apply_pricing_rule_on_item(e),t.product(t.frm.doc,t.frm.doc.doctype,t.frm.doc.name)})}item_code(t,r,_){var e=this,o=frappe.get_doc(r,_),a=0,i=0;o.weight_per_unit=0,o.weight_uom="",o.conversion_factor=0,["Sales Invoice","Purchase Invoice"].includes(this.frm.doc.doctype)?(a=cint(e.frm.doc.update_stock),i=a):(this.frm.doc.doctype==="Purchase Receipt"||this.frm.doc.doctype==="Delivery Note")&&(i=1),i&&o.use_serial_batch_fields===1&&(i=0);var n=!1;if(this.frm.doc.doctype==="Arrival Document"&&(n=!0),o.barcode=null,o.item_code||o.serial_no)if(!this.validate_company_and_party())this.frm.fields_dict.items.grid.grid_rows[o.idx-1].remove();else return o.pricing_rules="",this.frm.call({method:"erpnext.stock.get_item_details.get_item_details",child:o,args:{doc:e.frm.doc,args:{item_code:o.item_code,barcode:o.barcode,serial_no:o.serial_no,batch_no:o.batch_no,set_warehouse:e.frm.doc.set_warehouse,warehouse:o.warehouse,customer:e.frm.doc.customer||e.frm.doc.party_name,quotation_to:e.frm.doc.quotation_to,supplier:e.frm.doc.supplier,currency:e.frm.doc.currency,update_stock:a,conversion_rate:e.frm.doc.conversion_rate,price_list:e.frm.doc.selling_price_list||e.frm.doc.buying_price_list,price_list_currency:e.frm.doc.price_list_currency,plc_conversion_rate:e.frm.doc.plc_conversion_rate,company:e.frm.doc.company,order_type:e.frm.doc.order_type,is_pos:cint(e.frm.doc.is_pos),is_return:cint(e.frm.doc.is_return),is_subcontracted:e.frm.doc.is_subcontracted,ignore_pricing_rule:e.frm.doc.ignore_pricing_rule,doctype:e.frm.doc.doctype,name:e.frm.doc.name,project:o.project||e.frm.doc.project,qty:o.qty||1,net_rate:o.rate,base_net_rate:o.base_net_rate,stock_qty:o.stock_qty,conversion_factor:o.conversion_factor,weight_per_unit:o.weight_per_unit,uom:o.uom,weight_uom:o.weight_uom,manufacturer:o.manufacturer,stock_uom:o.stock_uom,pos_profile:cint(e.frm.doc.is_pos)?e.frm.doc.pos_profile:"",cost_center:o.cost_center,tax_category:e.frm.doc.tax_category,item_tax_template:o.item_tax_template,child_doctype:o.doctype,child_docname:o.name,is_old_subcontracting_flow:e.frm.doc.is_old_subcontracting_flow,teritorry:o.custom_territory}},callback:function(l){l.exc||frappe.run_serially([()=>{if(n){var c=locals[r][_];c.type_upselling==="Item Fix"?c.used_quantity=c.qty:c.used_quantity=0}},()=>{var c=locals[r][_];e.add_taxes_from_item_tax_template(c.item_tax_rate),c.free_item_data&&c.free_item_data.length>0&&e.apply_product_discount(c)},()=>{(e.frm.doc.is_internal_customer||e.frm.doc.is_internal_supplier)&&e.frm.doc.represents_company===e.frm.doc.company?e.get_incoming_rate(o,e.frm.posting_date,e.frm.posting_time,e.frm.doc.doctype,e.frm.doc.company):e.frm.script_manager.trigger("price_list_rate",r,_)},()=>{(e.frm.doc.is_internal_customer||e.frm.doc.is_internal_supplier)&&e.calculate_taxes_and_totals()},()=>e.toggle_conversion_factor(o),()=>{if(i&&!frappe.flags.trigger_from_barcode_scanner)return frappe.db.get_value("Item",o.item_code,["has_batch_no","has_serial_no"]).then(c=>{c.message&&(c.message.has_batch_no||c.message.has_serial_no)?frappe.flags.hide_serial_batch_dialog=!1:i=!1})},()=>{if(i&&!frappe.flags.hide_serial_batch_dialog)return frappe.db.get_single_value("Stock Settings","disable_serial_no_and_batch_selector").then(c=>{c&&(frappe.flags.hide_serial_batch_dialog=!0)})},()=>{if(i&&!frappe.flags.hide_serial_batch_dialog&&!frappe.flags.dialog_set){var c=locals[r][_];$.each(l.message,function(s,d){c[s]||(c[s]=d)}),c.has_batch_no&&c.has_serial_no&&(c.batch_no=void 0),frappe.flags.dialog_set=!0,erpnext.show_serial_batch_selector(e.frm,c,s=>{e.frm.script_manager.trigger("qty",s.doctype,s.name),e.frm.doc.set_warehouse||e.frm.script_manager.trigger("warehouse",s.doctype,s.name),e.apply_price_list(s,!0)},void 0,!frappe.flags.hide_serial_batch_dialog)}else frappe.flags.dialog_set=!1},()=>e.conversion_factor(t,r,_,!0),()=>e.remove_pricing_rule(o),()=>{if(o.apply_rule_on_other_items){let c=o.name;e.apply_rule_on_other_items({key:o})}},()=>{var c=e.get_company_currency();e.update_item_grid_labels(c)}])}})}qty(t,r,_){var e;if(!((e=this.frm.doc.__onload)!=null&&e.load_after_mapping)){let o=frappe.get_doc(r,_);frappe.run_serially([()=>this.remove_pricing_rule_for_item(o),()=>this.conversion_factor(t,r,_,!0),()=>this.calculate_stock_uom_rate(t,r,_),()=>this.apply_pricing_rule(o,!0)]),this.reaply_pricing_rule()}}product(t,r,_){var e=this,o=0,a=0;if(t.product)return frappe.call({method:"erpnext.stock.get_item_details.get_item_details",args:{doc:e.frm.doc,args:{item_code:t.product,warehouse:e.frm.doc.set_warehouse,customer:e.frm.doc.customer||e.frm.doc.party_name,quotation_to:e.frm.doc.quotation_to,supplier:e.frm.doc.supplier,currency:e.frm.doc.currency,update_stock:o,conversion_rate:e.frm.doc.conversion_rate,price_list:e.frm.doc.selling_price_list||e.frm.doc.buying_price_list,price_list_currency:e.frm.doc.price_list_currency,plc_conversion_rate:e.frm.doc.plc_conversion_rate,company:e.frm.doc.company,order_type:e.frm.doc.order_type,is_pos:cint(e.frm.doc.is_pos),is_return:cint(e.frm.doc.is_return),is_subcontracted:e.frm.doc.is_subcontracted,ignore_pricing_rule:e.frm.doc.ignore_pricing_rule,doctype:e.frm.doc.doctype,name:e.frm.doc.name,project:e.frm.doc.project,qty:1,net_rate:e.frm.doc.rate,base_net_rate:e.frm.doc.base_net_rate,stock_qty:e.frm.doc.stock_qty,conversion_factor:t.conversion_factor,weight_per_unit:t.weight_per_unit,uom:e.frm.doc.uom,weight_uom:e.frm.doc.weight_uom,manufacturer:e.frm.doc.manufacturer,stock_uom:e.frm.doc.stock_uom,pos_profile:cint(e.frm.doc.is_pos)?e.frm.doc.pos_profile:"",cost_center:e.frm.doc.cost_center,tax_category:e.frm.doc.tax_category,item_tax_template:e.frm.doc.item_tax_template,is_old_subcontracting_flow:e.frm.doc.is_old_subcontracting_flow,teritorry:e.frm.doc.territory_area}},callback:function(i){if(!i.exc){for(var n in i.message)e.frm.doc[n]=i.message[n];frappe.run_serially([()=>{e.frm.script_manager.trigger("price_list_rate",r,_)}])}}})}update_item_grid_labels(t){this.frm.set_currency_labels(["base_rate","base_net_rate","base_price_list_rate","base_amount","base_net_amount","base_rate_with_margin"],t,this.frm._item_table),this.frm.set_currency_labels(["rate","net_rate","price_list_rate","amount",`${this.frm._custom_field}otr_amount`,"net_amount","stock_uom_rate","rate_with_margin"],this.frm.doc.currency,this.frm._item_table)}toggle_item_grid_columns(t){let r=this;this.frm.toggle_display("base_net_total",e&&r.frm.doc.currency!=t);var _=this.frm.fields_dict.items.grid;$.each(["base_rate","base_price_list_rate","base_amount","base_rate_with_margin"],function(o,a){frappe.meta.get_docfield(_.doctype,a)&&_.set_column_disp(a,r.frm.doc.currency!=t),r.frm.toggle_display(a,r.frm.doc.currency!=t)});var e=cint(cur_frm.doc.discount_amount)||(cur_frm.doc.taxes||[]).filter(function(o){return o.included_in_print_rate===1}).length;$.each(["net_rate","net_amount"],function(o,a){frappe.meta.get_docfield(_.doctype,a)&&_.set_column_disp(a,e),r.frm.toggle_display(a,r.frm.doc.currency!=t)}),$.each(["base_net_rate","base_net_amount"],function(o,a){frappe.meta.get_docfield(_.doctype,a)&&_.set_column_disp(a,e&&r.frm.doc.currency!=t),r.frm.toggle_display(a,r.frm.doc.currency!=t)})}_set_values_for_item_list(t){let r={};for(let _ of t){let e=frappe.model.get_value(_.doctype,_.name,"pricing_rules");for(let[o,a]of Object.entries(_))if(!["doctype","name"].includes(o)&&(o==="pricing_rules"&&frappe.model.set_value(_.doctype,_.name,o,a),o!=="free_item_data")){if(_.apply_rule_on_other_items&&JSON.parse(_.apply_rule_on_other_items).length&&!in_list(JSON.parse(_.apply_rule_on_other_items),_.item_code))continue;frappe.model.set_value(_.doctype,_.name,o,a)}frappe.model.round_floats_in(frappe.get_doc(_.doctype,_.name),["price_list_rate","discount_percentage"]),!this.frm.doc.ignore_pricing_rule&&e&&!_.pricing_rules?this.apply_price_list(frappe.get_doc(_.doctype,_.name)):_.pricing_rules||this.remove_pricing_rule(frappe.get_doc(_.doctype,_.name)),_.free_item_data&&_.free_item_data.length>0&&this.apply_product_discount(_),_.apply_rule_on_other_items&&JSON.parse(_.apply_rule_on_other_items).length&&(r[_.name]=_)}this.apply_rule_on_other_items(r),this.calculate_taxes_and_totals()}price_list_rate(t,r,_){var e=frappe.get_doc(r,_);frappe.model.round_floats_in(e,["price_list_rate","discount_percentage"]),in_list(["Quotation Item","Sales Order Item","Delivery Note Item","Sales Invoice Item","POS Invoice Item","Purchase Invoice Item","Purchase Order Item","Purchase Receipt Item","FPK","SPK","Arrival Document Item","Billing Document Item"]),r?this.apply_pricing_rule_on_item(e):e.rate=flt(e.price_list_rate*(1-e.discount_percentage/100),precision("rate",e)),this.calculate_taxes_and_totals()}async apply_pricing_rule_on_item(t){var r=this;let _=t.price_list_rate,e=t.rate;["Sales Order","Quotation"].includes(t.parenttype)&&t.blanket_order_rate&&(_=t.blanket_order_rate);var o="",a="",i=100;["Sales Order","Quotation","Delivery Note","Sales Invoice","Arrival Document","Billing Document"].includes(t.parenttype)?(o=t.custom_territory_area,a=t.custom_off_the_road_pricing,["Sales Invoice"].includes(t.parenttype)?i=t.custom_term_portion||100:i=100):(o=this.frm.doc.custom_territory_pemilik||this.frm.doc.territory,a=this.frm.doc.off_the_road_pricing,i=100),await frappe.call({method:"stnk_bpkb.controllers.get_items_detail.get_rule_stnk_bpkb",args:{item_code:t.item_code||t.product,teritory:o,date:this.frm.doc.transaction_date||this.frm.doc.posting_date,is_ignore_rule_bbn:a},callback:n=>{n.exc||(console.log("hare"),window.location.hostname=="gtm.digitalasiasolusindo.com"&&console.log("GTM ONLY"),t[`${r.frm._custom_field}stnk_rate`]=t[`${r.frm._custom_field}bpkb_rate`]=t[`${r.frm._custom_field}bbn_rate`]=0,t[`${r.frm._custom_field}stnk_account`]=t[`${r.frm._custom_field}bpkb_account`]=t[`${r.frm._custom_field}bbn_account`]="",t[`${r.frm._custom_field}vendor`]=t[`${r.frm._custom_field}vendor`]=t[`${r.frm._custom_field}vendor`]="",$.each(n.message||[],function(l,c){!c.amount||(t[`${r.frm._custom_field+c.type.toLowerCase()}_rate`]=c.amount*(i/100),t[`${r.frm._custom_field+c.type.toLowerCase()}_account`]=c.coa,t[`${r.frm._custom_field}vendor`]=c.vendor,_+=flt(c.amount*(i/100)))}))}}),t.margin_type=="Percentage"?t.rate_with_margin=flt(_)+flt(_)*(flt(t.margin_rate_or_amount)/100):t.rate_with_margin=flt(_)+flt(t.margin_rate_or_amount),t.base_rate_with_margin=flt(t.rate_with_margin)*flt(this.frm.doc.conversion_rate),e=flt(t.rate_with_margin,precision("rate",t)),t.discount_percentage&&!t[this.frm._discount_field]&&(t[this.frm._discount_field]=flt(t.rate_with_margin)*flt(t.discount_percentage)/100),t[this.frm._discount_field]>0&&(e=flt(t.rate_with_margin-t[this.frm._discount_field],precision("rate",t)),t.discount_percentage=100*flt(t[this.frm._discount_field])/flt(t.rate_with_margin)),["Sales Order","Quotation","Delivery Note","Sales Invoice","Arrival Document","Billing Document"].includes(t.parenttype)?frappe.model.set_value(t.doctype,t.name,"rate",e):frappe.model.set_value(t.doctype,t.name,"rate",_)}_calculate_taxes_and_totals(){let t=this.frm.doc.doctype=="Quotation";this.frm._items=in_list(["FPK","SPK"],this.frm.doctype)?[this.frm.doc]:t?this.filtered_items():this.frm.doc.items,this.validate_conversion_rate(),this.calculate_item_values(),this.initialize_taxes(),this.determine_exclusive_rate(),this.calculate_net_total(),this.calculate_taxes(),this.manipulate_grand_total_for_inclusive_tax(),this.calculate_totals(),this._cleanup()}calculate_item_values(){var t=this;if(!this.discount_amount_applied)for(let _ of this.frm._items||[]){if(frappe.model.round_floats_in(_),window.location.hostname=="gtm.digitalasiasolusindo.com"){var r=0;["FPK","SPK"].includes(t.frm.doc.doctype)&&(r=_.total_additional_items),_.net_rate=_.rate-_[`${this.frm._custom_field}stnk_rate`]-_[`${this.frm._custom_field}bpkb_rate`]-_[`${this.frm._custom_field}bbn_rate`]+r,console.log(r,_.net_rate)}else _.net_rate=_.rate-_[`${this.frm._custom_field}stnk_rate`]-_[`${this.frm._custom_field}bpkb_rate`]-_[`${this.frm._custom_field}bbn_rate`];if(_.qty=_.qty===void 0?t.frm.doc.is_return?-1:1:_.qty,!(t.frm.doc.is_return||t.frm.doc.is_debit_note))_[`${this.frm._custom_field}otr_amount`]=flt(_.rate*_.qty,precision(`${this.frm._custom_field}otr_amount`,_)),_.net_amount=_.amount=flt(_.net_rate*_.qty,precision("amount",_));else{let e=flt(_.qty);e||(e=t.frm.doc.is_debit_note?1:-1,t.frm.doc.doctype!=="Purchase Receipt"&&t.frm.doc.is_return===1&&(e=flt(_.qty))),_[`${this.frm._custom_field}otr_amount`]=flt(_.rate*e,precision(`${this.frm._custom_field}otr_amount`,_)),_.net_amount=_.amount=flt(_.net_rate*e,precision("net_amount",_))}_[`${this.frm._custom_field}stnk_amount`]=flt(_[`${this.frm._custom_field}stnk_rate`]*_.qty,precision(`${this.frm._custom_field}stnk_amount`,_)),_[`${this.frm._custom_field}bpkb_amount`]=flt(_[`${this.frm._custom_field}bpkb_rate`]*_.qty,precision(`${this.frm._custom_field}bpkb_amount`,_)),_[`${this.frm._custom_field}bbn_amount`]=flt(_[`${this.frm._custom_field}bbn_rate`]*_.qty,precision(`${this.frm._custom_field}bbn_amount`,_)),_.item_tax_amount=0,_.total_weight=flt(_.weight_per_unit*_.stock_qty),t.set_in_company_currency(_,["price_list_rate","rate","amount","net_rate","net_amount"])}}initialize_taxes(){var t=this;$.each(this.frm.doc.taxes||[],function(r,_){_.dont_recompute_tax||(_.item_wise_tax_detail={});var e=["total","tax_amount_after_discount_amount","tax_amount_for_current_item","grand_total_for_current_item","tax_fraction_for_current_item","grand_total_fraction_for_current_item"];cstr(_.charge_type)!="Actual"&&!(t.discount_amount_applied&&t.frm.doc.apply_discount_on=="Grand Total")&&e.push("tax_amount"),$.each(e,function(o,a){_[a]=0}),this.discount_amount_applied||(erpnext.accounts.taxes.validate_taxes_and_charges(_.doctype,_.name),erpnext.accounts.taxes.validate_inclusive_tax(_)),frappe.model.round_floats_in(_)})}calculate_taxes(){var t=this;this.frm.doc.rounding_adjustment=0;var r={};$.each(this.frm.doc.taxes||[],function(_,e){e.charge_type=="Actual"&&(r[e.idx]=flt(e.tax_amount,precision("tax_amount",e)))}),$.each(this.frm._items||[],function(_,e){var o=t._load_item_tax_rate(e.item_tax_rate);$.each(t.frm.doc.taxes||[],function(a,i){var n=t.get_current_tax_amount(e,i,o);if(frappe.flags.round_row_wise_tax&&(n=flt(n,precision("tax_amount",i))),i.charge_type=="Actual"&&(r[i.idx]-=n,_==t.frm._items.length-1&&(n+=r[i.idx])),i.charge_type!="Actual"&&!(t.discount_amount_applied&&t.frm.doc.apply_discount_on=="Grand Total")&&(i.tax_amount+=n),i.tax_amount_for_current_item=n,i.tax_amount_after_discount_amount+=n,i.category&&(n=i.category=="Valuation"?0:n,n*=i.add_deduct_tax=="Deduct"?-1:1),a==0?i.grand_total_for_current_item=flt(e.net_amount+n):i.grand_total_for_current_item=flt(t.frm.doc.taxes[a-1].grand_total_for_current_item+n),_==t.frm._items.length-1&&(t.round_off_totals(i),t.set_in_company_currency(i,["tax_amount","tax_amount_after_discount_amount"]),t.round_off_base_values(i),t.set_cumulative_total(a,i),t.set_in_company_currency(i,["total"]),a==t.frm.doc.taxes.length-1&&t.discount_amount_applied&&t.frm.doc.apply_discount_on=="Grand Total"&&t.frm.doc.discount_amount)){var l=flt(t.frm.doc[`${t.frm._custom_field}total_stnk`])+flt(t.frm.doc[`${t.frm._custom_field}total_bpkb`])+flt(t.frm.doc[`${t.frm._custom_field}total_bbn`]);t.frm.doc.rounding_adjustment=flt(t.frm.doc.grand_total-l-flt(t.frm.doc.discount_amount)-i.total,precision("rounding_adjustment")),console.log(`${t.frm.doc.grand_total} - ${l} - ${flt(t.frm.doc.discount_amount)} - ${i.total}`)}})})}determine_exclusive_rate(){var t=this,r=!1;$.each(t.frm.doc.taxes||[],function(_,e){cint(e.included_in_print_rate)&&(r=!0)}),r!=!1&&$.each(t.frm._items||[],function(_,e){var o=t._load_item_tax_rate(e.item_tax_rate),a=0,i=0;if($.each(t.frm.doc.taxes||[],function(l,c){var s=t.get_current_tax_fraction(c,o);c.tax_fraction_for_current_item=s[0];var d=s[1];l==0?c.grand_total_fraction_for_current_item=1+c.tax_fraction_for_current_item:c.grand_total_fraction_for_current_item=t.frm.doc.taxes[l-1].grand_total_fraction_for_current_item+c.tax_fraction_for_current_item,a+=c.tax_fraction_for_current_item,i+=d*flt(e.qty)}),!t.discount_amount_applied&&e.qty&&(i||a)){var n=flt(e.amount)-i;e.net_amount=flt(n/(1+a)),e.net_rate=e.qty?flt(e.net_amount/e.qty,precision("net_rate",e)):0,t.set_in_company_currency(e,["net_rate","net_amount"])}})}apply_discount_amount(){var t=this,r=0;if(this.frm.doc.base_discount_amount=0,this.frm.doc.discount_amount){if(this.frm.doc.apply_discount_on||frappe.throw(__("Please select Apply Discount On")),this.frm.doc.base_discount_amount=flt(this.frm.doc.discount_amount*this.frm.doc.conversion_rate,precision("base_discount_amount")),this.frm.doc.apply_discount_on=="Grand Total"&&this.frm.doc.is_cash_or_non_trade_discount)return;var _=this.get_total_for_discount_amount(),e=0;_&&($.each(this.frm._items||[],function(o,a){if(r=flt(t.frm.doc.discount_amount)*a.net_amount/_,a.net_amount=flt(a.net_amount-r,precision("base_amount",a)),e+=a.net_amount,(!(t.frm.doc.taxes||[]).length||_==t.frm.doc.net_total||t.frm.doc.apply_discount_on=="Net Total")&&o==(t.frm._items||[]).length-1){var i=flt(t.frm.doc.net_total-e-t.frm.doc.discount_amount,precision("net_total"));a.net_amount=flt(a.net_amount+i,precision("net_amount",a))}a.net_rate=a.qty?flt(a.net_amount/a.qty,precision("net_rate",a)):0,t.set_in_company_currency(a,["net_rate","net_amount"])}),this.discount_amount_applied=!0,this._calculate_taxes_and_totals())}}get_total_for_discount_amount(){if(this.frm.doc.apply_discount_on=="Net Total")return this.frm.doc.net_total;var t=0,r={};return $.each(this.frm.doc.taxes||[],function(_,e){if(["Actual","On Item Quantity"].includes(e.charge_type)){var o=e.category=="Valuation"?0:e.tax_amount;o*=e.add_deduct_tax=="Deduct"?-1:1,r[e.idx]=o}else if(r[e.row_id]!==null){var a=flt(r[e.row_id])*flt(e.rate)/100;r[e.idx]=a}}),$.each(r,function(_,e){e&&(t+=e)}),t+=flt(this.frm.doc[`${this.frm._custom_field}total_stnk`])+flt(this.frm.doc[`${this.frm._custom_field}total_bpkb`])+flt(this.frm.doc[`${this.frm._custom_field}total_bbn`]),flt(this.frm.doc.grand_total-t,precision("grand_total"))}calculate_net_total(){var t=this;this.frm.doc.total_qty=this.frm.doc.total=this.frm.doc.base_total=this.frm.doc.net_total=this.frm.doc.base_net_total=this.frm.doc[`${this.frm._custom_field}total_stnk`]=this.frm.doc[`${this.frm._custom_field}total_bpkb`]=this.frm.doc[`${this.frm._custom_field}total_bbn`]=0,$.each(this.frm._items||[],function(r,_){t.frm.doc[`${t.frm._custom_field}total_stnk`]+=_[`${t.frm._custom_field}stnk_amount`],t.frm.doc[`${t.frm._custom_field}total_bpkb`]+=_[`${t.frm._custom_field}bpkb_amount`],t.frm.doc[`${t.frm._custom_field}total_bbn`]+=_[`${t.frm._custom_field}bbn_amount`],t.frm.doc.total+=_.amount,t.frm.doc.total_qty+=_.qty,t.frm.doc.base_total+=_.base_amount,t.frm.doc.net_total+=_.net_amount,t.frm.doc.base_net_total+=_.base_net_amount})}calculate_totals(){var t=this,r=this.frm.doc.taxes?this.frm.doc.taxes.length:0,_=flt(t.frm.doc[`${this.frm._custom_field}total_stnk`])+flt(t.frm.doc[`${this.frm._custom_field}total_bpkb`])+flt(t.frm.doc[`${this.frm._custom_field}total_bbn`]);this.frm.doc.grand_total=flt(r?this.frm.doc.taxes[r-1].total+flt(this.frm.doc.rounding_adjustment):this.frm.doc.net_total)+_,in_list(["Quotation","Sales Order","Delivery Note","Sales Invoice","Arrival Document","POS Invoice","SPK","FPK","Billing Document"],this.frm.doc.doctype)?this.frm.doc.base_grand_total=this.frm.doc.total_taxes_and_charges?flt(this.frm.doc.grand_total*this.frm.doc.conversion_rate):this.frm.doc.base_net_total+_:(this.frm.doc.taxes_and_charges_added=this.frm.doc.taxes_and_charges_deducted=0,r&&($.each(this.frm.doc.taxes||[],function(e,o){in_list(["Valuation and Total","Total"],o.category)&&(o.add_deduct_tax=="Add"?t.frm.doc.taxes_and_charges_added+=flt(o.tax_amount_after_discount_amount):t.frm.doc.taxes_and_charges_deducted+=flt(o.tax_amount_after_discount_amount))}),frappe.model.round_floats_in(this.frm.doc,["taxes_and_charges_added","taxes_and_charges_deducted"])),this.frm.doc.base_grand_total=flt(this.frm.doc.taxes_and_charges_added||this.frm.doc.taxes_and_charges_deducted?flt(this.frm.doc.grand_total*this.frm.doc.conversion_rate):this.frm.doc.base_net_total),this.set_in_company_currency(this.frm.doc,["taxes_and_charges_added","taxes_and_charges_deducted"])),this.frm.doc.total_taxes_and_charges=flt(this.frm.doc.grand_total-this.frm.doc.net_total-_-flt(this.frm.doc.rounding_adjustment),precision("total_taxes_and_charges")),this.set_in_company_currency(this.frm.doc,["total_taxes_and_charges","rounding_adjustment"]),frappe.model.round_floats_in(this.frm.doc,["grand_total","base_grand_total"]),this.set_rounded_total()}}}};})();
//# sourceMappingURL=stnk_bpkb.bundle.DPTOSHGN.js.map
